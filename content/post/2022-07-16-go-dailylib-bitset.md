---
layout:    post
title:    "Go æ¯æ—¥ä¸€åº“ä¹‹ bitset"
subtitle: "æ¯å¤©å­¦ä¹ ä¸€ä¸ª Go åº“"
date:     2022-07-16T12:30:23
author:   "darjun"
image:    "img/post-bg-2015.jpg"
tags:
    - Go æ¯æ—¥ä¸€åº“
URL: "2022/07/16/godailylib/bitset"
categories: [
  "Go"
]
---

## ç®€ä»‹

æˆ‘ä»¬éƒ½çŸ¥é“è®¡ç®—æœºæ˜¯åŸºäºäºŒè¿›åˆ¶çš„ï¼Œä½è¿ç®—æ˜¯è®¡ç®—æœºçš„åŸºç¡€è¿ç®—ã€‚ä½è¿ç®—çš„ä¼˜åŠ¿å¾ˆæ˜æ˜¾ï¼ŒCPU æŒ‡ä»¤åŸç”Ÿæ”¯æŒã€é€Ÿåº¦å¿«ã€‚åŸºäºä½è¿ç®—çš„ä½é›†åˆåœ¨æœ‰é™çš„åœºæ™¯ä¸­æ›¿æ¢é›†åˆæ•°æ®ç»“æ„å¯ä»¥æ”¶åˆ°æ„æƒ³ä¸åˆ°çš„æ•ˆæœã€‚[`bitset`](https://github.com/bits-and-blooms/bitset)åº“å®ç°äº†ä½é›†åˆåŠç›¸å…³æ“ä½œï¼Œä¸å¦¨æ‹¿æ¥å³ç”¨ã€‚

## å®‰è£…

æœ¬æ–‡ä»£ç ä½¿ç”¨ Go Modulesã€‚

åˆ›å»ºç›®å½•å¹¶åˆå§‹åŒ–ï¼š

```cmd
$ mkdir -p bitset && cd bitset
$ go mod init github.com/darjun/go-daily-lib/bitset
```

å®‰è£…`bitset`åº“ï¼š

```cmd
$ go get -u github.com/bits-and-blooms/bitset
```

## ä½¿ç”¨

ä½é›†åˆçš„åŸºæœ¬æ“ä½œæœ‰ï¼š

* æ£€æŸ¥ä½ï¼ˆTestï¼‰ï¼šæ£€æŸ¥æŸä¸ªç´¢å¼•æ˜¯å¦ä¸º 1ã€‚ç±»æ¯”æ£€æŸ¥å…ƒç´ æ˜¯å¦åœ¨é›†åˆä¸­
* è®¾ç½®ä½ï¼ˆSetï¼‰ï¼šå°†æŸä¸ªç´¢å¼•è®¾ç½®ä¸º 1ã€‚ç±»æ¯”å‘é›†åˆæ·»åŠ å…ƒç´ 
* æ¸…é™¤ä½ï¼ˆClearï¼‰ï¼šå°†æŸä¸ªç´¢å¼•æ¸…é™¤ï¼Œè®¾ç½®ä¸º 0ã€‚ç±»æ¯”ä»é›†åˆä¸­åˆ é™¤å…ƒç´ 
* ç¿»è½¬ä½ï¼ˆFlipï¼‰ï¼šå¦‚æœæŸä¸ªç´¢å¼•ä¸º 1ï¼Œåˆ™è®¾ç½®ä¸º 0ï¼Œåä¹‹è®¾ç½®ä¸º 1
* å¹¶ï¼ˆUnionï¼‰ï¼šä¸¤ä¸ªä½é›†åˆæ‰§è¡Œå¹¶æ“ä½œã€‚ç±»æ¯”é›†åˆçš„å¹¶
* äº¤ï¼ˆIntersectionï¼‰ï¼šä¸¤ä¸ªä½é›†åˆæ‰§è¡Œäº¤æ“ä½œã€‚ç±»æ¯”é›†åˆçš„äº¤

ä½é›†åˆä¸€èˆ¬ç”¨äºå°æ•°å€¼çš„éè´Ÿæ•´æ•°çš„åœºæ™¯ä¸­ã€‚å°±æ‹¿æ¸¸æˆä¸­ç®€å•çš„ç­¾åˆ°ä¸¾ä¾‹å§ï¼Œå¾ˆå¤šæ¸¸æˆéƒ½æœ‰ç­¾åˆ°æ´»åŠ¨ï¼ŒçŸ­çš„æœ‰ 7 å¤©çš„ï¼Œé•¿çš„æœ‰ 30 å¤©ã€‚è¿™ç§å°±å¾ˆé€‚åˆä½¿ç”¨ä½é›†åˆã€‚æ¯ä¸ªä½çš„å€¼è¡¨ç¤ºå…¶ç´¢å¼•ä½ç½®å¯¹åº”çš„é‚£å¤©æœ‰æ²¡æœ‰ç­¾åˆ°ã€‚

```golang
type Player struct {
  sign *bitset.BitSet
}

func NewPlayer(sign uint) *Player {
  return &Player{
    sign: bitset.From([]uint64{uint64(sign)}),
  }
}

func (this *Player) Sign(day uint) {
  this.sign.Set(day)
}

func (this *Player) IsSigned(day uint) bool {
  return this.sign.Test(day)
}

func main() {
  player := NewPlayer(1) // ç¬¬ä¸€å¤©ç­¾åˆ°
  for day := uint(2); day <= 7; day++ {
    if rand.Intn(100)&1 == 0 {
      player.Sign(day - 1)
    }
  }

  for day := uint(1); day <= 7; day++ {
    if player.IsSigned(day - 1) {
      fmt.Printf("day:%d signed\n", day)
    }
  }
}
```

bitset æä¾›äº†å¤šç§åˆ›å»º BitSet å¯¹è±¡çš„æ–¹æ³•ã€‚

é¦–å…ˆ bitset.BitSet é›¶å€¼å¯ç”¨ï¼Œå¦‚æœä¸€å¼€å§‹ä¸çŸ¥é“æœ‰å¤šå°‘å…ƒç´ ï¼Œå¯ä»¥ä½¿ç”¨è¿™ç§æ–¹å¼åˆ›å»ºï¼š

```golang
var b bitset.BitSet
```

BitSet åœ¨è®¾ç½®æ—¶è‡ªåŠ¨è°ƒæ•´å¤§å°ã€‚å¦‚æœäº‹å…ˆçŸ¥é“é•¿åº¦ï¼Œåˆ›å»º BitSet æ—¶å¯ä¼ å…¥æ­¤å€¼ï¼Œèƒ½æœ‰æ•ˆé¿å…è‡ªåŠ¨è°ƒæ•´çš„å¼€é”€ï¼š

```golang
b := bitset.New(100)
```

bitset ç»“æ„æ”¯æŒé“¾å¼è°ƒç”¨ï¼Œå¤§éƒ¨åˆ†æ–¹æ³•è¿”å›è‡ªèº«çš„æŒ‡é’ˆï¼Œæ‰€ä»¥å¯ä»¥è¿™æ ·å†™ï¼š

```golang
b.Set(10).Set(11).Clear(12).Flip(13);
```

æ³¨æ„ï¼Œbitset çš„ç´¢å¼•æ˜¯ä» 0 å¼€å§‹çš„ã€‚

è®°å¾—ä¹‹å‰åœ¨ç½‘ä¸Šçœ‹è¿‡ä¸€é“é¢˜ï¼š

ä¸€ä¸ªå†œå¤«å¸¦ç€ä¸€åªç‹¼ã€ä¸€å¤´ç¾Šå’Œä¸€é¢—ç™½èœæ¥åˆ°æ²³è¾¹ã€‚ä»–éœ€è¦ç”¨èˆ¹æŠŠä»–ä»¬å¸¦åˆ°å¯¹å²¸ã€‚ç„¶è€Œï¼Œè¿™è‰˜èˆ¹åªèƒ½å®¹ä¸‹å†œå¤«æœ¬äººå’Œå¦å¤–ä¸€ç§ä¸œè¥¿ï¼ˆè¦ä¹ˆæ˜¯ç‹¼ï¼Œè¦ä¹ˆæ˜¯ç¾Šï¼Œè¦ä¹ˆæ˜¯ç™½èœï¼‰ã€‚å¦‚æœå†œå¤«ä¸åœ¨åœºçš„è¯ï¼Œç‹¼å°±ä¼šåƒæ‰ç¾Šï¼Œç¾Šä¼šåƒæ‰ç™½èœã€‚è¯·ä¸ºå†œå¤«è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

è¿™å…¶å®æ˜¯ä¸€ä¸ªçŠ¶æ€æœç´¢çš„é—®é¢˜ï¼Œç”¨å›æº¯æ³•å°±èƒ½è§£å†³ã€‚å†œå¤«ã€ç‹¼ã€ç¾Šã€ç™½èœéƒ½æœ‰ä¸¤ä¸ªçŠ¶æ€ï¼Œå³åœ¨æ²³å·¦å²¸ï¼ˆå‡è®¾åˆšå¼€å§‹å†œå¤«æ‰€å¤„çš„æ˜¯å·¦å²¸ï¼‰è¿˜æ˜¯æ²³å³å²¸ã€‚è¿™é‡Œå®é™…ä¸Šè¿˜æœ‰ä¸ªèˆ¹çš„çŠ¶æ€ï¼Œç”±äºèˆ¹ä¸€å®šå’Œå†œå¤«çš„çŠ¶æ€æ˜¯ä¸€è‡´çš„ï¼Œå°±ä¸ç”¨é¢å¤–è€ƒè™‘äº†ã€‚è¿™äº›çŠ¶æ€æˆ‘ä»¬å¾ˆå®¹æ˜“ç”¨ä½é›†åˆæ¥è¡¨ç¤ºï¼š

```golang
const (
  FARMER = iota
  WOLF
  SHEEP
  CABBAGE
)
```

ç¼–å†™ä¸€ä¸ªå‡½æ•°æ¥åˆ¤æ–­çŠ¶æ€æ˜¯å¦åˆæ³•ã€‚æœ‰ä¸¤ç§çŠ¶æ€ä¸åˆæ³•ï¼š

* ç‹¼å’Œç¾Šåœ¨åŒä¸€è¾¹ï¼Œå¹¶ä¸”ä¸å’Œå†œå¤«åœ¨åŒä¸€è¾¹ã€‚æ­¤æ—¶ç‹¼ä¼šåƒæ‰ç¾Š
* ç¾Šå’Œç™½èœåœ¨åŒä¸€è¾¹ï¼Œå¹¶ä¸”ä¸å’Œå†œå¤«åœ¨åŒä¸€è¾¹ã€‚æ­¤æ—¶ç¾Šä¼šåƒæ‰ç™½èœ

```golang
func IsStateValid(state *bitset.BitSet) bool {
  if state.Test(WOLF) == state.Test(SHEEP) &&
    state.Test(WOLF) != state.Test(FARMER) {
    // ç‹¼å’Œç¾Šåœ¨åŒä¸€è¾¹ï¼Œå¹¶ä¸”ä¸å’Œå†œå¤«åœ¨åŒä¸€è¾¹
    // ç‹¼ä¼šåƒæ‰ç¾Šï¼Œéæ³•
    return false
  }

  if state.Test(SHEEP) == state.Test(CABBAGE) &&
    state.Test(SHEEP) != state.Test(FARMER) {
    // ç¾Šå’Œç™½èœåœ¨åŒä¸€è¾¹ï¼Œå¹¶ä¸”ä¸å’Œå†œå¤«åœ¨åŒä¸€è¾¹
    // ç¾Šä¼šåƒæ‰ç™½èœï¼Œéæ³•
    return false
  }

  return true
}
```

æ¥ä¸‹æ¥ç¼–å†™æœç´¢å‡½æ•°ï¼š

```golang
func search(b *bitset.BitSet, visited map[string]struct{}) bool {
  if !IsStateValid(b) {
    return false
  }

  if _, exist := visited[b.String()]; exist {
    // çŠ¶æ€å·²éå†
    return false
  }

  if b.Count() == 4 {
    return true
  }

  visited[b.String()] = struct{}{}
  for index := uint(FARMER); index <= CABBAGE; index++ {
    if b.Test(index) != b.Test(FARMER) {
      // ä¸å†œå¤«ä¸åœ¨ä¸€è¾¹ï¼Œä¸èƒ½å¸¦ä¸Šèˆ¹
      continue
    }

    // å¸¦åˆ°å¯¹å²¸å»
    b.Flip(index)
    if index != FARMER {
      // å¦‚æœ index ä¸º FARMERï¼Œè¡¨ç¤ºä¸å¸¦ä»»ä½•ä¸œè¥¿
      b.Flip(FARMER)
    }

    if search(b, visited) {
      return true
    }

    // çŠ¶æ€æ¢å¤
    b.Flip(index)
    if index != FARMER {
      b.Flip(FARMER)
    }
  }

  return false
}
```

ä¸»å‡½æ•°ï¼š

```golang
func main() {
  b := bitset.New(4)

  visited := make(map[string]struct{})
  fmt.Println(search(b, visited))
}
```

åˆå§‹æ—¶ï¼Œæ‰€æœ‰çŠ¶æ€ä¸º 0ï¼Œéƒ½åˆ°å¯¹å²¸ä¹‹åæ‰€æœ‰çŠ¶æ€ä¸º 1ï¼Œæ•…`b.Count() == 4`è¡¨ç¤ºéƒ½å·²åˆ°è¾¾å¯¹å²¸äº†ã€‚ç”±äºæœç´¢æ˜¯ç›²ç›®çš„ï¼Œå¯èƒ½ä¼šæ— é™å¾ªç¯ï¼šè¿™æ¬¡å†œå¤«å°†ç¾Šå¸¦åˆ°å¯¹å²¸ï¼Œä¸‹æ¬¡åˆå°†å…¶ä»å¯¹å²¸å¸¦å›æ¥äº†ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦åšçŠ¶æ€å»é‡ã€‚`bitset.String()`è¿”å›å½“å‰ä½é›†åˆçš„å­—ç¬¦ä¸²è¡¨ç¤ºï¼Œæˆ‘ä»¬ä»¥æ­¤æ¥åˆ¤æ–­çŠ¶æ€æ˜¯å¦é‡å¤ã€‚

for å¾ªç¯ä¾æ¬¡å°è¯•å¸¦å„ç§ç‰©å“ï¼Œæˆ–ä»€ä¹ˆä¹Ÿä¸å¸¦ã€‚é©±åŠ¨æŸ¥æ‰¾è¿‡ç¨‹ã€‚

å¦‚æœæƒ³å¾—åˆ°å†œå¤«æ­£ç¡®çš„åŠ¨ä½œåºåˆ—ï¼Œå¯ä»¥ç»™ search åŠ ä¸€ä¸ªå‚æ•°ï¼Œè®°å½•æ¯ä¸€æ­¥çš„æ“ä½œï¼š

```golang
func search(b *bitset.BitSet, visited map[string]struct{}, path *[]*bitset.BitSet) bool {
  // è®°å½•è·¯å¾„
  *path = append(*path, b.Clone())
  if b.Count() == 4 {
    return true
  }

  // ...
  *path = (*path)[:len(*path)-1]

  return false
}

func main() {
  b := bitset.New(4)

  visited := make(map[string]struct{})
  var path []*bitset.BitSet
  if search(b, visited, &path) {
    PrintPath(path)
  }
}
```

å¦‚æœæ‰¾åˆ°è§£ï¼Œæ‰“å°ä¹‹ï¼š

```golang
var names = []string{"å†œå¤«", "ç‹¼", "ç¾Š", "ç™½èœ"}

func PrintState(b *bitset.BitSet) {
  fmt.Println("=======================")
  fmt.Println("æ²³å·¦å²¸ï¼š")
  for index := uint(FARMER); index <= CABBAGE; index++ {
    if !b.Test(index) {
      fmt.Println(names[index])
    }
  }

  fmt.Println("æ²³å³å²¸ï¼š")
  for index := uint(FARMER); index <= CABBAGE; index++ {
    if b.Test(index) {
      fmt.Println(names[index])
    }
  }
  fmt.Println("=======================")
}

func PrintMove(cur, next *bitset.BitSet) {
  for index := uint(WOLF); index <= CABBAGE; index++ {
    if cur.Test(index) != next.Test(index) {
      if !cur.Test(FARMER) {
        fmt.Printf("å†œå¤«å°†ã€%sã€‘ä»æ²³å·¦å²¸å¸¦åˆ°æ²³å³å²¸\n", names[index])
      } else {
        fmt.Printf("å†œå¤«å°†ã€%sã€‘ä»æ²³å³å²¸å¸¦åˆ°æ²³å·¦å²¸\n", names[index])

      }
      return
    }
  }

  if !cur.Test(FARMER) {
    fmt.Println("å†œå¤«ç‹¬è‡ªä»æ²³å·¦å²¸åˆ°æ²³å³å²¸")
  } else {
    fmt.Println("å†œå¤«ç‹¬è‡ªä»æ²³å³å²¸åˆ°æ²³å·¦å²¸")
  }
}

func PrintPath(path []*bitset.BitSet) {
  cur := path[0]
  PrintState(cur)

  for i := 1; i < len(path); i++ {
    next := path[i]
    PrintMove(cur, next)
    PrintState(next)
    cur = next
  }
}
```

è¿è¡Œï¼š

```
=======================
æ²³å·¦å²¸ï¼š
å†œå¤«
ç‹¼
ç¾Š
ç™½èœ

æ²³å³å²¸ï¼š
=======================
å†œå¤«å°†ã€ç¾Šã€‘ä»æ²³å·¦å²¸å¸¦åˆ°æ²³å³å²¸
=======================
æ²³å·¦å²¸ï¼š
ç‹¼
ç™½èœ

æ²³å³å²¸ï¼š
å†œå¤«
ç¾Š
=======================
å†œå¤«ç‹¬è‡ªä»æ²³å³å²¸åˆ°æ²³å·¦å²¸
=======================
æ²³å·¦å²¸ï¼š
å†œå¤«
ç‹¼
ç™½èœ

æ²³å³å²¸ï¼š
ç¾Š
=======================
å†œå¤«å°†ã€ç‹¼ã€‘ä»æ²³å·¦å²¸å¸¦åˆ°æ²³å³å²¸
=======================
æ²³å·¦å²¸ï¼š
ç™½èœ

æ²³å³å²¸ï¼š
å†œå¤«
ç‹¼
ç¾Š
=======================
å†œå¤«å°†ã€ç¾Šã€‘ä»æ²³å³å²¸å¸¦åˆ°æ²³å·¦å²¸
=======================
æ²³å·¦å²¸ï¼š
å†œå¤«
ç¾Š
ç™½èœ

æ²³å³å²¸ï¼š
ç‹¼
=======================
å†œå¤«å°†ã€ç™½èœã€‘ä»æ²³å·¦å²¸å¸¦åˆ°æ²³å³å²¸
=======================
æ²³å·¦å²¸ï¼š
ç¾Š

æ²³å³å²¸ï¼š
å†œå¤«
ç‹¼
ç™½èœ
=======================
å†œå¤«ç‹¬è‡ªä»æ²³å³å²¸åˆ°æ²³å·¦å²¸
=======================
æ²³å·¦å²¸ï¼š
å†œå¤«
ç¾Š

æ²³å³å²¸ï¼š
ç‹¼
ç™½èœ
=======================
å†œå¤«å°†ã€ç¾Šã€‘ä»æ²³å·¦å²¸å¸¦åˆ°æ²³å³å²¸
=======================
æ²³å·¦å²¸ï¼š

æ²³å³å²¸ï¼š
å†œå¤«
ç‹¼
ç¾Š
ç™½èœ
=======================
```

å³å†œå¤«æ“ä½œè¿‡ç¨‹ä¸ºï¼šå°†ç¾Šå¸¦åˆ°å³å²¸->ç‹¬è‡ªè¿”å›->å°†ç™½èœå¸¦åˆ°å³å²¸->å†å°†ç¾Šå¸¦å›å·¦å²¸->å¸¦ä¸Šç‹¼åˆ°å³å²¸->ç‹¬è‡ªè¿”å›->æœ€åå°†ç¾Šå¸¦åˆ°å³å²¸->å®Œæˆã€‚

## ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å®ƒï¼Ÿ

ä¼¼ä¹ç›´æ¥ä½¿ç”¨ä½è¿ç®—å°±å¯ä»¥äº†ï¼Œä¸ºä»€ä¹ˆè¦ä½¿ç”¨ bitset åº“å‘¢ï¼Ÿ

å› ä¸ºé€šç”¨ï¼Œä¸Šé¢åˆ—ä¸¾çš„ä¸¤ä¸ªä¾‹å­éƒ½æ˜¯å¾ˆå°çš„æ•´æ•°å€¼ï¼Œå¦‚æœæ•´æ•°å€¼è¶…è¿‡ 64 ä½ï¼Œæˆ‘ä»¬å¿…ç„¶è¦é€šè¿‡åˆ‡ç‰‡æ¥å­˜å‚¨ã€‚æ­¤æ—¶æ‰‹å†™æ“ä½œå°±éå¸¸ä¸ä¾¿äº†ï¼Œè€Œä¸”å®¹æ˜“å‡ºé”™ã€‚

åº“çš„ä¼˜åŠ¿ä½“ç°åœ¨ï¼š

* è¶³å¤Ÿé€šç”¨
* æŒç»­ä¼˜åŒ–
* å¤§è§„æ¨¡ä½¿ç”¨

åªè¦å¯¹å¤–æä¾›çš„æ¥å£ä¿æŒä¸å˜ï¼Œå®ƒå¯ä»¥ä¸€ç›´ä¼˜åŒ–å†…éƒ¨å®ç°ã€‚è™½ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥åšï¼Œä½†æ˜¯è´¹æ—¶è´¹åŠ›ã€‚è€Œä¸”æœ‰äº›ä¼˜åŒ–æ¶‰åŠåˆ°æ¯”è¾ƒå¤æ‚çš„ç®—æ³•ï¼Œè‡ªå·±å®ç°çš„éš¾åº¦è¾ƒé«˜ä¸”æ˜“é”™ã€‚

æœ‰ä¸€ä¸ªå¾ˆå…¸å‹çš„ä¾‹å­ï¼Œæ±‚ä¸€ä¸ª uint64 çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸­ 1 çš„æ•°é‡ï¼ˆpopcntï¼Œæˆ– population countï¼‰ã€‚å®ç°çš„æ–¹æ³•æœ‰å¾ˆå¤šã€‚

æœ€ç›´æ¥çš„ï¼Œæˆ‘ä»¬ä¸€ä½ä¸€ä½åœ°ç»Ÿè®¡ï¼š

```golang
func popcnt1(n uint64) uint64 {
  var count uint64

  for n > 0 {
    if n&1 == 1 {
      count++
    }

    n >>= 1
  }

  return count
}
```

è€ƒè™‘ç©ºé—´æ¢æ—¶é—´ï¼Œæˆ‘ä»¬å¯ä»¥é¢„å…ˆè®¡ç®— 0-255 è¿™ 256 ä¸ªæ•°å­—çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸­ 1 çš„ä¸ªæ•°ï¼Œç„¶åæ¯ 8 ä½è®¡ç®—ä¸€æ¬¡ï¼Œå¯èƒ½å°†è®¡ç®—æ¬¡æ•°å‡å°‘åˆ°ä¹‹å‰çš„ 1/8ã€‚è¿™ä¹Ÿæ˜¯æ ‡å‡†åº“ä¸­çš„åšæ³•ï¼š

```golang
const pop8tab = "" +
  "\x00\x01\x01\x02\x01\x02\x02\x03\x01\x02\x02\x03\x02\x03\x03\x04" +
  "\x01\x02\x02\x03\x02\x03\x03\x04\x02\x03\x03\x04\x03\x04\x04\x05" +
  "\x01\x02\x02\x03\x02\x03\x03\x04\x02\x03\x03\x04\x03\x04\x04\x05" +
  "\x02\x03\x03\x04\x03\x04\x04\x05\x03\x04\x04\x05\x04\x05\x05\x06" +
  "\x01\x02\x02\x03\x02\x03\x03\x04\x02\x03\x03\x04\x03\x04\x04\x05" +
  "\x02\x03\x03\x04\x03\x04\x04\x05\x03\x04\x04\x05\x04\x05\x05\x06" +
  "\x02\x03\x03\x04\x03\x04\x04\x05\x03\x04\x04\x05\x04\x05\x05\x06" +
  "\x03\x04\x04\x05\x04\x05\x05\x06\x04\x05\x05\x06\x05\x06\x06\x07" +
  "\x01\x02\x02\x03\x02\x03\x03\x04\x02\x03\x03\x04\x03\x04\x04\x05" +
  "\x02\x03\x03\x04\x03\x04\x04\x05\x03\x04\x04\x05\x04\x05\x05\x06" +
  "\x02\x03\x03\x04\x03\x04\x04\x05\x03\x04\x04\x05\x04\x05\x05\x06" +
  "\x03\x04\x04\x05\x04\x05\x05\x06\x04\x05\x05\x06\x05\x06\x06\x07" +
  "\x02\x03\x03\x04\x03\x04\x04\x05\x03\x04\x04\x05\x04\x05\x05\x06" +
  "\x03\x04\x04\x05\x04\x05\x05\x06\x04\x05\x05\x06\x05\x06\x06\x07" +
  "\x03\x04\x04\x05\x04\x05\x05\x06\x04\x05\x05\x06\x05\x06\x06\x07" +
  "\x04\x05\x05\x06\x05\x06\x06\x07\x05\x06\x06\x07\x06\x07\x07\x08"

func popcnt2(n uint64) uint64 {
  var count uint64

  for n > 0 {
    count += uint64(pop8tab[n&0xff])
    n >>= 8
  }

  return count
}
```

æœ€åæ˜¯ bitset åº“ä¸­çš„ç®—æ³•ï¼š

```golang
func popcnt3(x uint64) (n uint64) {
  x -= (x >> 1) & 0x5555555555555555
  x = (x>>2)&0x3333333333333333 + x&0x3333333333333333
  x += x >> 4
  x &= 0x0f0f0f0f0f0f0f0f
  x *= 0x0101010101010101
  return x >> 56
}
```

å¯¹ä»¥ä¸Šä¸‰ç§å®ç°è¿›è¡Œæ€§èƒ½æµ‹è¯•ï¼š

```golang
goos: windows
goarch: amd64
pkg: github.com/darjun/go-daily-lib/bitset/popcnt
cpu: Intel(R) Core(TM) i7-7700 CPU @ 3.60GHz
BenchmarkPopcnt1-8         52405             24409 ns/op
BenchmarkPopcnt2-8        207452              5443 ns/op
BenchmarkPopcnt3-8       1777320               602 ns/op
PASS
ok      github.com/darjun/go-daily-lib/bitset/popcnt    4.697s
```

popcnt3 ç›¸å¯¹ popcnt1 æœ‰ 40 å€çš„æ€§èƒ½æå‡ã€‚åœ¨å­¦ä¹ ä¸Šæˆ‘ä»¬å¯ä»¥è‡ªå·±å°è¯•é€ è½®å­ï¼Œä»¥æ­¤æ¥åŠ æ·±è‡ªå·±å¯¹æŠ€æœ¯çš„ç†è§£ã€‚ä½†æ˜¯åœ¨å·¥ç¨‹ä¸Šï¼Œé€šå¸¸æ›´å€¾å‘äºä½¿ç”¨ç¨³å®šçš„ã€é«˜æ•ˆçš„åº“ã€‚

## æ€»ç»“

æœ¬æ–‡å€Ÿç€ bitset åº“ä»‹ç»äº†ä½é›†åˆçš„ä½¿ç”¨ã€‚å¹¶ä¸”åº”ç”¨ bitset è§£å†³äº†å†œå¤«è¿‡æ²³é—®é¢˜ã€‚æœ€åæˆ‘ä»¬è®¨è®ºäº†ä¸ºä»€ä¹ˆè¦ä½¿ç”¨åº“ï¼Ÿ

å¤§å®¶å¦‚æœå‘ç°å¥½ç©ã€å¥½ç”¨çš„ Go è¯­è¨€åº“ï¼Œæ¬¢è¿åˆ° Go æ¯æ—¥ä¸€åº“ GitHub ä¸Šæäº¤ issueğŸ˜„

## ä¸€ç‚¹é—²è¯

æˆ‘å‘ç°äººçš„æƒ°æ€§å®åœ¨æ˜¯å¤ªå¯æ€•äº†ã€‚è™½ç„¶è¿™åŠå¹´æ¥æ²¡å†™æ–‡ç« ä¸€å¼€å§‹æ˜¯å› ä¸ºå·¥ä½œä¸Šçš„åŸå› ï¼Œåæ¥å•çº¯æ˜¯å› ä¸ºæƒ¯æ€§ï¼Œå› ä¸ºæ‡’ã€‚è€Œä¸”æ€»æ˜¯â€œè£…ç€å¾ˆå¿™â€æ¥é€ƒé¿éœ€è¦èŠ±æ—¶é—´ã€èŠ±ç²¾åŠ›çš„äº‹æƒ…ã€‚åœ¨è¿™ç§æƒ³åŠ¨åˆä¸æƒ³åŠ¨çš„è§’é€ä¹‹é—´ï¼Œæ—¶é—´å°±è¿™ä¹ˆä¸€æ™ƒè€Œè¿‡ã€‚

æˆ‘ä»¬æ€»æ˜¯åœ¨æŠ±æ€¨æ²¡æœ‰æ—¶é—´ï¼Œæ²¡æœ‰æ—¶é—´ã€‚ä½†ä»”ç»†æƒ³æƒ³ï¼Œä»”ç»†ç®—ç®—ï¼Œæˆ‘ä»¬èŠ±åœ¨åˆ·çŸ­è§†é¢‘ï¼Œç©æ¸¸æˆä¸Šçš„æ—¶é—´å…¶å®å¹¶ä¸å°‘ã€‚

ä¸Šå‘¨æˆ‘åœ¨é˜®ä¸€å³°è€å¸ˆçš„å‘¨åˆŠä¸Šçœ‹åˆ°ä¸€ç¯‡æ–‡ç« ã€Šäººç”Ÿä¸çŸ­ã€‹ï¼Œçœ‹äº†ä¹‹åæ·±æœ‰è§¦åŠ¨ã€‚äººæ€»è¯¥æœ‰æ‰€åšæŒï¼Œç”Ÿæ´»æ‰æœ‰æ„ä¹‰ã€‚

## å‚è€ƒ

1. bitset GitHubï¼š[github.com/bits-and-blooms/bitset](https://github.com/bits-and-blooms/bitset)
2. Go æ¯æ—¥ä¸€åº“ GitHubï¼š[https://github.com/darjun/go-daily-lib](https://github.com/darjun/go-daily-lib)

## æˆ‘

æˆ‘çš„åšå®¢ï¼š[https://darjun.github.io](https://darjun.github.io)

æ¬¢è¿å…³æ³¨æˆ‘çš„å¾®ä¿¡å…¬ä¼—å·ã€GoUpUpã€‘ï¼Œå…±åŒå­¦ä¹ ï¼Œä¸€èµ·è¿›æ­¥~

![](/img/wxsearch.png#center)