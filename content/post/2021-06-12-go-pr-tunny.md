---
layout:    post
title:    "ä¸º tunny æäº¤çš„ä¸€æ¬¡ PR"
subtitle: "æ¯å¤©è¿›æ­¥ä¸€ç‚¹ç‚¹"
date:		2021-06-12T11:48:30
author:		"darjun"
image:	"img/post-bg-2015.jpg"
tags:
    - Go æ¯æ—¥ä¸€åº“
URL: "2021/06/12/pr/tunny"
categories: [
	"Go"
]
---

## èƒŒæ™¯

ä¸Šå‘¨æˆ‘å†™äº†ä¸€ç¯‡æ–‡ç« [Go æ¯æ—¥ä¸€åº“ä¹‹ ants](https://darjun.github.io/2021/06/03/godailylib/ants)ï¼Œæ·±å…¥å‰–æäº†`ants`è¿™ä¸ª goroutine æ± çš„å®ç°ã€‚åœ¨åå¤é˜…è¯»äº†å¤šé[panjf2000](https://github.com/panjf2000)å…³äº`ants`çš„èµ·æºçš„æ–‡ç« â€”â€”[GMP å¹¶å‘è°ƒåº¦å™¨æ·±åº¦è§£æä¹‹æ‰‹æ’¸ä¸€ä¸ªé«˜æ€§èƒ½ goroutine pool](https://strikefreedom.top/high-performance-implementation-of-goroutine-pool)ï¼Œæˆ‘æ„Ÿè§‰æ”¶è·æ»¡æ»¡ã€‚è¿™ç¯‡æ–‡ç« å¯¹äºç†è§£ Go çš„ goroutine å¹¶å‘æœºåˆ¶æœ‰å¾ˆå¤§çš„å‚è€ƒä»·å€¼ï¼Œå¼ºçƒˆå»ºè®®ä¸€è¯»ã€‚ç„¶åæˆ‘èŠ±äº†å‡ ä¸ªå°æ—¶æ—¶é—´è¯¦ç»†é˜…è¯»äº†`ants`çš„æºç ï¼Œä»£ç å†™çš„å¾ˆæ£’ï¼Œéå¸¸ä¼˜ç¾ã€‚è€Œåæˆ‘å†™äº†ä¸€éæ–‡ç« åˆ†æäº†`ants`çš„æºç ï¼Œè§[`ants`æºç èµæ](https://darjun.github.io/2021/06/04/godailylib/ants-src/)ã€‚åœ¨å†™ä»‹ç»`ants`çš„æ–‡ç« å’Œæ·±å…¥é˜…è¯»æºç è¿‡ç¨‹ä¸­ï¼Œç½‘ä¸Šçš„èµ„æ–™æåŠ Go è¯­è¨€ä¸­ goroutine æ± çš„å®ç°ï¼Œæ—¶å¸¸ä¼šå¸¦ä¸Š`tunny`è¿™ä¸ªåº“ã€‚äºæ˜¯ï¼Œæˆ‘åˆå»ç ”ç©¶äº†`tunny`çš„æºç ï¼Œäº§å‡ºä¸€ç¯‡æ–‡ç« [Go æ¯æ—¥ä¸€åº“ä¹‹ tunny](https://darjun.github.io/2021/06/10/godailylib/tunny/)ã€‚

åœ¨é˜…è¯»`tunny`æºç æ—¶ï¼Œæˆ‘å‘ç°æœ‰ä¸ªæ–¹æ³•çš„å®ç°æœ‰äº›é—®é¢˜ã€‚æˆ‘ä¹Ÿåœ¨[Go æ¯æ—¥ä¸€åº“ä¹‹ tunny](https://darjun.github.io/2021/06/10/godailylib/tunny/)ä¸­ä¹ŸæŒ‡å‡ºäº†ï¼š

![](/img/in-post/pr/tunny1.png#center)

## åŸç†

æˆ‘ä»¬çŸ¥é“ slice ç»“æ„ä¸­æœ‰ä¸€ä¸ªæŒ‡å‘æ•°ç»„çš„æŒ‡é’ˆã€‚å‡è®¾ä¸€å¼€å§‹`tunny`ä¸­æœ‰ 5 ä¸ª workerï¼Œç¤ºæ„å›¾å¦‚ä¸‹ï¼š

![](/img/in-post/pr/tunny2.png#center)

æ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ª`worker`ç»“æ„ã€‚ç„¶åæˆ‘ä»¬ä½¿ç”¨`s := s[:4]`ç¼©å®¹äº†ï¼Œè¿›å˜æˆäº†ä¸‹é¢è¿™æ ·ï¼š

![](/img/in-post/pr/tunny3.png#center)

ç°åœ¨æœ€åä¸€ä¸ªå…ƒç´ æ— æ³•é€šè¿‡åˆ‡ç‰‡è®¿é—®äº†ï¼Œä½†æ˜¯åˆè¢«åº•å±‚æ•°ç»„å¼•ç”¨ç€ï¼Œæ— æ³•è¢« Go è¿è¡Œæ—¶çš„ gc æ¸…ç†æ‰ï¼Œ360 è½¯ä»¶ç®¡å®¶éƒ½ä¸è¡Œã€‚è¿™å°±æœ‰å†…å­˜æ³„æ¼äº†ã€‚è™½ç„¶è¿™ä¸ªæ³„æ¼å¹¶ä¸ä¸¥é‡ï¼Œä¸€æ˜¯å› ä¸ºé‡ä¸å¯èƒ½å¾ˆå¤§ï¼Œå› ä¸º worker æ•°é‡æœ‰é™ï¼ŒäºŒæ˜¯ä¸‹æ¬¡æ‰©å®¹åä½ç½®è¢«è¦†ç›–å°±å¯ä»¥é‡Šæ”¾åŸ worker äº†ï¼ˆå› ä¸ºæ²¡æœ‰å¼•ç”¨å®ƒçš„æŒ‡é’ˆäº†ï¼‰ã€‚

`ants`æºç ä¸­ä¹Ÿæœ‰ç±»ä¼¼çš„æ“ä½œï¼Œä½†æ˜¯ä¼šå°†ç¼©å®¹æ‰çš„å…ƒç´ ç½®ä¸º`nil`ã€‚ä¾‹å¦‚`worker_stack.go`ä¸­çš„`reset()`æ–¹æ³•ï¼š

```golang
func (wq *workerStack) reset() {
  for i := 0; i < wq.len(); i++ {
    wq.items[i].task <- nil
    wq.items[i] = nil
  }
  wq.items = wq.items[:0]
}
```

## PR

ç¡®å®šäº†é—®é¢˜ã€‚æˆ‘å…ˆ fork äº†`tunny`çš„ä»“åº“ã€‚ç‚¹å‡» fork æŒ‰é’®ï¼š

![](/img/in-post/pr/tunny4.png#center)

è€Œåå°† fork åçš„æˆ‘è‡ªå·±çš„ä»“åº“ä¸‹è½½ï¼š

```cmd
$ git clone git@github.com:darjun/tunny.git
```

ä¿®æ”¹ä»£ç ï¼Œcommitï¼Œpush åˆ°æˆ‘çš„è¿œç¨‹ä»“åº“ã€‚ä¸‹é¢æ˜¯æˆ‘æ‰€åšçš„æ”¹åŠ¨ï¼š

![](/img/in-post/pr/tunny5.png#center)

ç„¶åå»`tunny`æºä»“åº“ï¼Œç‚¹å‡»`Pull Request`æŒ‰é’®ã€‚ç„¶åç‚¹å‡»å³ä¾§çš„`New pull request`æŒ‰é’®ï¼š

![](/img/in-post/pr/tunny6.png#center)

æ–°å»ºä¸€ä¸ª PRï¼Œç„¶åç‚¹å‡»`compare across forks`ï¼Œé€‰æ‹©æˆ‘çš„ forkï¼š

![](/img/in-post/pr/tunny7.png#center)

é€‰æ‹©æˆ‘åšä¿®æ”¹çš„é‚£æ¬¡æäº¤ï¼Œç„¶åå¡«å†™ä¿¡æ¯ï¼Œæäº¤ï¼Œç”±äºæˆ‘å·²ç»æäº¤äº† PRã€‚è¿™æ¬¡æ¯”è¾ƒå°±æ²¡æœ‰å·®å¼‚äº†ã€‚

ç„¶åç­‰å¾…ä½œè€…åˆå¹¶ã€‚ä¸€å¤©åï¼Œä½œè€…åˆå¹¶äº†è¿™æ¬¡ä¿®æ”¹ï¼š

![](/img/in-post/pr/tunny8.png#center)

## æ€»ç»“

GitHub æäº¤ PR å¹¶ä¸éš¾ï¼Œå¤§åˆ°æ–°å¢ç‰¹æ€§ï¼Œå°åˆ°ä¸€ä¸ªæ‹¼å†™é”™è¯¯ï¼Œéƒ½å¯ä»¥æ PRã€‚ç›¸ä¿¡ä¸å°‘äººéƒ½å¬è¯´è¿‡ï¼ŒLinus Torvalds äº²è‡ªåˆå¹¶äº†ä¸€ä¸ªæ¥è‡ª 11 å²å°å­©æäº¤çš„å…³äº Linux æºç æ³¨é‡Šä¸­æ‹¼å†™é”™è¯¯çš„ PRã€‚

GitHub ä¸Š star å¾ˆå¤šçš„é¡¹ç›®å¹¶éå®Œç¾ï¼Œè‚¯å®šä¹Ÿæœ‰å¾ˆå¤šå€¼å¾—æ”¹è¿›çš„åœ°æ–¹ã€‚æ‰€ä»¥é˜…è¯»æºç æ—¶éœ€è¦å¸¦æœ‰ä¸€å®šçš„æ€€ç–‘ç²¾ç¥ï¼Œä¸è¦æŠŠä»€ä¹ˆå¥‰ä¸ºåœ­è‡¬ã€‚

å¤§å®¶å¦‚æœå‘ç°å¥½ç©ã€å¥½ç”¨çš„ Go è¯­è¨€åº“ï¼Œæ¬¢è¿åˆ° Go æ¯æ—¥ä¸€åº“ GitHub ä¸Šæäº¤ issueğŸ˜„

## å‚è€ƒ

1. tunny GitHubï¼š[github.com/Jeffail/tunny](https://github.com/Jeffail/tunny)
2. ants GitHubï¼š[github.com/panjf2000/ants](https://github.com/panjf2000/ants)
3. Go æ¯æ—¥ä¸€åº“ GitHubï¼š[https://github.com/darjun/go-daily-lib](https://github.com/darjun/go-daily-lib)

## æˆ‘

æˆ‘çš„åšå®¢ï¼š[https://darjun.github.io](https://darjun.github.io)

æ¬¢è¿å…³æ³¨æˆ‘çš„å¾®ä¿¡å…¬ä¼—å·ã€GoUpUpã€‘ï¼Œå…±åŒå­¦ä¹ ï¼Œä¸€èµ·è¿›æ­¥~