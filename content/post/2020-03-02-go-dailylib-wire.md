---
layout:    post
title:    "Go æ¯æ—¥ä¸€åº“ä¹‹ wire"
subtitle: 	"æ¯å¤©å­¦ä¹ ä¸€ä¸ª Go åº“"
date:		2020-03-02T15:11:23
author:		"darjun"
image:	"img/post-bg-2015.jpg"
tags:
    - Go æ¯æ—¥ä¸€åº“
URL: "2020/03/02/godailylib/wire"
categories: [
	"Go"
]
---

## ç®€ä»‹

ä¹‹å‰çš„ä¸€ç¯‡æ–‡ç« [Go æ¯æ—¥ä¸€åº“ä¹‹ dig](https://darjun.github.io/2020/02/22/godailylib/dig/)ä»‹ç»äº† uber å¼€æºçš„ä¾èµ–æ³¨å…¥æ¡†æ¶`dig`ã€‚è¯»äº†è¿™ç¯‡æ–‡ç« åï¼Œ[@overtalk](https://github.com/overtalk)æ¨èäº† Google å¼€æºçš„`wire`å·¥å…·ã€‚æ‰€ä»¥å°±æœ‰äº†ä»Šå¤©è¿™ç¯‡æ–‡ç« ï¼Œæ„Ÿè°¢æ¨èğŸ‘

[`wire`](https://github.com/google/wire)æ˜¯ Google å¼€æºçš„ä¸€ä¸ªä¾èµ–æ³¨å…¥å·¥å…·ã€‚å®ƒæ˜¯ä¸€ä¸ªä»£ç ç”Ÿæˆå™¨ï¼Œå¹¶ä¸æ˜¯ä¸€ä¸ªæ¡†æ¶ã€‚æˆ‘ä»¬åªéœ€è¦åœ¨ä¸€ä¸ªç‰¹æ®Šçš„`go`æ–‡ä»¶ä¸­å‘Šè¯‰`wire`ç±»å‹ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œå®ƒä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬ç”Ÿæˆä»£ç ï¼Œå¸®åŠ©æˆ‘ä»¬åˆ›å»ºæŒ‡å®šç±»å‹çš„å¯¹è±¡ï¼Œå¹¶ç»„è£…å®ƒçš„ä¾èµ–ã€‚

## å¿«é€Ÿä½¿ç”¨

å…ˆå®‰è£…å·¥å…·ï¼š

```golang
$ go get github.com/google/wire/cmd/wire
```

ä¸Šé¢çš„å‘½ä»¤ä¼šåœ¨`$GOPATH/bin`ä¸­ç”Ÿæˆä¸€ä¸ªå¯æ‰§è¡Œç¨‹åº`wire`ï¼Œè¿™å°±æ˜¯ä»£ç ç”Ÿæˆå™¨ã€‚æˆ‘ä¸ªäººä¹ æƒ¯æŠŠ`$GOPATH/bin`åŠ å…¥ç³»ç»Ÿç¯å¢ƒå˜é‡`$PATH`ä¸­ï¼Œæ‰€ä»¥å¯ç›´æ¥åœ¨å‘½ä»¤è¡Œä¸­æ‰§è¡Œ`wire`å‘½ä»¤ã€‚

ä¸‹é¢æˆ‘ä»¬åœ¨ä¸€ä¸ªä¾‹å­ä¸­çœ‹çœ‹å¦‚ä½•ä½¿ç”¨`wire`ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬æ¥åˆ°ä¸€ä¸ªé»‘æš—çš„ä¸–ç•Œï¼Œè¿™ä¸ªä¸–ç•Œä¸­æœ‰ä¸€ä¸ªé‚ªæ¶çš„æ€ªå…½ã€‚æˆ‘ä»¬ç”¨ä¸‹é¢çš„ç»“æ„è¡¨ç¤ºï¼ŒåŒæ—¶ç¼–å†™ä¸€ä¸ªåˆ›å»ºæ–¹æ³•ï¼š

```golang
type Monster struct {
  Name string
}

func NewMonster() Monster {
  return Monster{Name: "kitty"}
}
```

æœ‰æ€ªå…½è‚¯å®šå°±æœ‰å‹‡å£«ï¼Œç»“æ„å¦‚ä¸‹ï¼ŒåŒæ ·åœ°å®ƒä¹Ÿæœ‰åˆ›å»ºæ–¹æ³•ï¼š

```golang
type Player struct {
  Name string
}

func NewPlayer(name string) Player {
  return Player{Name: name}
}
```

ç»ˆäºæœ‰ä¸€å¤©ï¼Œå‹‡å£«å®Œæˆäº†ä»–çš„ä½¿å‘½ï¼Œæˆ˜èƒœäº†æ€ªå…½ï¼š

```golang
type Mission struct {
  Player  Player
  Monster Monster
}

func NewMission(p Player, m Monster) Mission {
  return Mission{p, m}
}

func (m Mission) Start() {
  fmt.Printf("%s defeats %s, world peace!\n", m.Player.Name, m.Monster.Name)
}
```

è¿™å¯èƒ½æ˜¯æŸä¸ªæ¸¸æˆé‡Œé¢çš„åœºæ™¯å“ˆï¼Œæˆ‘ä»¬çœ‹å¦‚ä½•å°†ä¸Šé¢çš„ç»“æ„ç»„è£…èµ·æ¥æ”¾åœ¨ä¸€ä¸ªåº”ç”¨ç¨‹åºä¸­ï¼š

```golang
func main() {
  monster := NewMonster()
  player := NewPlayer("dj")
  mission := NewMission(player, monster)

  mission.Start()
}
```

ä»£ç é‡å°‘ï¼Œç»“æ„ä¸å¤æ‚çš„æƒ…å†µä¸‹ï¼Œä¸Šé¢çš„å®ç°æ–¹å¼ç¡®å®æ²¡ä»€ä¹ˆé—®é¢˜ã€‚ä½†æ˜¯é¡¹ç›®åºå¤§åˆ°ä¸€å®šç¨‹åº¦ï¼Œç»“æ„ä¹‹é—´çš„å…³ç³»å˜å¾—éå¸¸å¤æ‚çš„æ—¶å€™ï¼Œè¿™ç§æ‰‹åŠ¨åˆ›å»ºæ¯ä¸ªä¾èµ–ï¼Œç„¶åå°†å®ƒä»¬ç»„è£…èµ·æ¥çš„æ–¹å¼å°±ä¼šå˜å¾—å¼‚å¸¸ç¹çï¼Œå¹¶ä¸”å®¹æ˜“å‡ºé”™ã€‚è¿™ä¸ªæ—¶å€™å‹‡å£«`wire`å‡ºç°äº†ï¼

`wire`çš„è¦æ±‚å¾ˆç®€å•ï¼Œæ–°å»ºä¸€ä¸ª`wire.go`æ–‡ä»¶ï¼ˆæ–‡ä»¶åå¯ä»¥éšæ„ï¼‰ï¼Œåˆ›å»ºæˆ‘ä»¬çš„åˆå§‹åŒ–å‡½æ•°ã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬è¦åˆ›å»ºå¹¶åˆå§‹åŒ–ä¸€ä¸ª`Mission`å¯¹è±¡ï¼Œæˆ‘ä»¬å°±å¯ä»¥è¿™æ ·ï¼š

```golang
//+build wireinject

package main

import "github.com/google/wire"

func InitMission(name string) Mission {
  wire.Build(NewMonster, NewPlayer, NewMission)
  return Mission{}
}
```

é¦–å…ˆè¿™ä¸ªå‡½æ•°çš„è¿”å›å€¼å°±æ˜¯æˆ‘ä»¬éœ€è¦åˆ›å»ºçš„å¯¹è±¡ç±»å‹ï¼Œ`wire`åªéœ€è¦çŸ¥é“ç±»å‹ï¼Œ`return`åè¿”å›ä»€ä¹ˆä¸é‡è¦ã€‚ç„¶ååœ¨å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨`wire.Build()`å°†åˆ›å»º`Mission`æ‰€ä¾èµ–çš„ç±»å‹çš„æ„é€ å™¨ä¼ è¿›å»ã€‚ä¾‹å¦‚ï¼Œéœ€è¦è°ƒç”¨`NewMission()`åˆ›å»º`Mission`ç±»å‹ï¼Œ`NewMission()`æ¥å—ä¸¤ä¸ªå‚æ•°ä¸€ä¸ª`Monster`ç±»å‹ï¼Œä¸€ä¸ª`Player`ç±»å‹ã€‚`Monster`ç±»å‹å¯¹è±¡éœ€è¦è°ƒç”¨`NewMonster()`åˆ›å»ºï¼Œ`Player`ç±»å‹å¯¹è±¡éœ€è¦è°ƒç”¨`NewPlayer()`åˆ›å»ºã€‚æ‰€ä»¥`NewMonster()`å’Œ`NewPlayer()`æˆ‘ä»¬ä¹Ÿéœ€è¦ä¼ ç»™`wire`ã€‚

æ–‡ä»¶ç¼–å†™å®Œæˆä¹‹åï¼Œæ‰§è¡Œ`wire`å‘½ä»¤ï¼š

```golang
$ wire
wire: github.com/darjun/go-daily-lib/wire/get-started/after: \
wrote D:\code\golang\src\github.com\darjun\go-daily-lib\wire\get-started\after\wire_gen.go
```

æˆ‘ä»¬çœ‹çœ‹ç”Ÿæˆçš„`wire_gen.go`æ–‡ä»¶ï¼š

```golang
// Code generated by Wire. DO NOT EDIT.

//go:generate wire
//+build !wireinject

package main

// Injectors from wire.go:

func InitMission(name string) Mission {
  player := NewPlayer(name)
  monster := NewMonster()
  mission := NewMission(player, monster)
  return mission
}
```

è¿™ä¸ª`InitMission()`å‡½æ•°æ˜¯ä¸æ˜¯å’Œæˆ‘ä»¬åœ¨`main.go`ä¸­ç¼–å†™çš„ä»£ç ä¸€æ¯›ä¸€æ ·ï¼æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨`main.go`è°ƒç”¨`InitMission()`ï¼š

```golang
func main() {
  mission := InitMission("dj")

  mission.Start()
}
```

ç»†å¿ƒçš„ç«¥é‹å¯èƒ½å‘ç°äº†ï¼Œ`wire.go`å’Œ`wire_gen.go`æ–‡ä»¶å¤´éƒ¨ä½ç½®éƒ½æœ‰ä¸€ä¸ª`+build`ï¼Œä¸è¿‡ä¸€ä¸ªåé¢æ˜¯`wireinject`ï¼Œå¦ä¸€ä¸ªæ˜¯`!wireinject`ã€‚`+build`å…¶å®æ˜¯ Go è¯­è¨€çš„ä¸€ä¸ªç‰¹æ€§ã€‚ç±»ä¼¼ C/C++ çš„æ¡ä»¶ç¼–è¯‘ï¼Œåœ¨æ‰§è¡Œ`go build`æ—¶å¯ä¼ å…¥ä¸€äº›é€‰é¡¹ï¼Œæ ¹æ®è¿™ä¸ªé€‰é¡¹å†³å®šæŸäº›æ–‡ä»¶æ˜¯å¦ç¼–è¯‘ã€‚`wire`å·¥å…·åªä¼šå¤„ç†æœ‰`wireinject`çš„æ–‡ä»¶ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„`wire.go`æ–‡ä»¶è¦åŠ ä¸Šè¿™ä¸ªã€‚ç”Ÿæˆçš„`wire_gen.go`æ˜¯ç»™æˆ‘ä»¬æ¥ä½¿ç”¨çš„ï¼Œ`wire`ä¸éœ€è¦å¤„ç†ï¼Œæ•…æœ‰`!wireinject`ã€‚

ç”±äºç°åœ¨æ˜¯ä¸¤ä¸ªæ–‡ä»¶ï¼Œæˆ‘ä»¬ä¸èƒ½ç”¨`go run main.go`è¿è¡Œç¨‹åºï¼Œå¯ä»¥ç”¨`go run .`è¿è¡Œã€‚è¿è¡Œç»“æœä¸ä¹‹å‰çš„ä¾‹å­ä¸€æ¨¡ä¸€æ ·ï¼

æ³¨æ„ï¼Œå¦‚æœä½ è¿è¡Œæ—¶ï¼Œå‡ºç°äº†`InitMission`é‡å®šä¹‰ï¼Œé‚£ä¹ˆæ£€æŸ¥ä¸€ä¸‹ä½ çš„`//+build wireinject`ä¸`package main`è¿™ä¸¤è¡Œä¹‹é—´æ˜¯å¦æœ‰ç©ºè¡Œï¼Œè¿™ä¸ªç©ºè¡Œå¿…é¡»è¦æœ‰ï¼è§[https://github.com/google/wire/issues/117](https://github.com/google/wire/issues/117)ã€‚ä¸­æ‹›çš„é»˜é»˜åœ¨å¿ƒé‡Œæ‰“ä¸ª 1 å¥½å˜›ğŸ˜‚

## åŸºç¡€æ¦‚å¿µ

`wire`æœ‰ä¸¤ä¸ªåŸºç¡€æ¦‚å¿µï¼Œ`Provider`ï¼ˆæ„é€ å™¨ï¼‰å’Œ`Injector`ï¼ˆæ³¨å…¥å™¨ï¼‰ã€‚`Provider`å®é™…ä¸Šå°±æ˜¯åˆ›å»ºå‡½æ•°ï¼Œå¤§å®¶æ„ä¼šä¸€ä¸‹ã€‚æˆ‘ä»¬ä¸Šé¢`InitMission`å°±æ˜¯`Injector`ã€‚æ¯ä¸ªæ³¨å…¥å™¨å®é™…ä¸Šå°±æ˜¯ä¸€ä¸ªå¯¹è±¡çš„åˆ›å»ºå’Œåˆå§‹åŒ–å‡½æ•°ã€‚åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦å‘Šè¯‰`wire`è¦åˆ›å»ºä»€ä¹ˆç±»å‹çš„å¯¹è±¡ï¼Œè¿™ä¸ªç±»å‹çš„ä¾èµ–ï¼Œ`wire`å·¥å…·ä¼šä¸ºæˆ‘ä»¬ç”Ÿæˆä¸€ä¸ªå‡½æ•°å®Œæˆå¯¹è±¡çš„åˆ›å»ºå’Œåˆå§‹åŒ–å·¥ä½œã€‚

## å‚æ•°

åŒæ ·ç»†å¿ƒçš„ä½ åº”è¯¥å‘ç°äº†ï¼Œæˆ‘ä»¬ä¸Šé¢ç¼–å†™çš„`InitMission()`å‡½æ•°å¸¦æœ‰ä¸€ä¸ª`string`ç±»å‹çš„å‚æ•°ã€‚å¹¶ä¸”åœ¨ç”Ÿæˆçš„`InitMission()`å‡½æ•°ä¸­ï¼Œè¿™ä¸ªå‚æ•°ä¼ ç»™äº†`NewPlayer()`ã€‚`NewPlayer()`éœ€è¦`string`ç±»å‹çš„å‚æ•°ï¼Œè€Œå‚æ•°ç±»å‹å°±æ˜¯`string`ã€‚æ‰€ä»¥ç”Ÿæˆçš„`InitMission()`å‡½æ•°ä¸­ï¼Œè¿™ä¸ªå‚æ•°å°±è¢«ä¼ ç»™äº†`NewPlayer()`ã€‚å¦‚æœæˆ‘ä»¬è®©`NewMonster()`ä¹Ÿæ¥å—ä¸€ä¸ª`string`å‚æ•°å‘¢ï¼Ÿ

```golang
func NewMonster(name string) Monster {
  return Monster{Name: name}
}
```

é‚£ä¹ˆç”Ÿæˆçš„`InitMission()`å‡½æ•°ä¸­`NewPlayer()`å’Œ`NewMonster()`éƒ½ä¼šå¾—åˆ°è¿™ä¸ªå‚æ•°ï¼š

```golang
func InitMission(name string) Mission {
  player := NewPlayer(name)
  monster := NewMonster(name)
  mission := NewMission(player, monster)
  return mission
}
```

å®é™…ä¸Šï¼Œ`wire`åœ¨ç”Ÿæˆä»£ç æ—¶ï¼Œæ„é€ å™¨éœ€è¦çš„å‚æ•°ï¼ˆæˆ–è€…å«ä¾èµ–ï¼‰ä¼šä»å‚æ•°ä¸­æŸ¥æ‰¾æˆ–é€šè¿‡å…¶å®ƒæ„é€ å™¨ç”Ÿæˆã€‚å†³å®šé€‰æ‹©å“ªä¸ªå‚æ•°æˆ–æ„é€ å™¨å®Œå…¨æ ¹æ®ç±»å‹ã€‚å¦‚æœå‚æ•°æˆ–æ„é€ å™¨ç”Ÿæˆçš„å¯¹è±¡æœ‰ç±»å‹ç›¸åŒçš„æƒ…å†µï¼Œè¿è¡Œ`wire`å·¥å…·æ—¶ä¼šæŠ¥é”™ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦å®šåˆ¶åˆ›å»ºè¡Œä¸ºï¼Œå°±éœ€è¦ä¸ºä¸åŒç±»å‹åˆ›å»ºä¸åŒçš„å‚æ•°ç»“æ„ï¼š

```golang
type PlayerParam string
type MonsterParam string

func NewPlayer(name PlayerParam) Player {
  return Player{Name: string(name)}
}

func NewMonster(name MonsterParam) Monster {
  return Monster{Name: string(name)}
}

func main() {
  mission := InitMission("dj", "kitty")
  mission.Start()
}

// wire.go
func InitMission(p PlayerParam, m MonsterParam) Mission {
  wire.Build(NewPlayer, NewMonster, NewMission)
  return Mission{}
}
```

ç”Ÿæˆçš„ä»£ç å¦‚ä¸‹ï¼š

```golang
func InitMission(m MonsterParam, p PlayerParam) Mission {
  player := NewPlayer(p)
  monster := NewMonster(m)
  mission := NewMission(player, monster)
  return mission
}
```

åœ¨å‚æ•°æ¯”è¾ƒå¤æ‚çš„æ—¶å€™ï¼Œå»ºè®®å°†å‚æ•°æ”¾åœ¨ä¸€ä¸ªç»“æ„ä¸­ã€‚

## é”™è¯¯

ä¸æ˜¯æ‰€æœ‰çš„æ„é€ æ“ä½œéƒ½èƒ½æˆåŠŸï¼Œæ²¡å‡†å‹‡å£«å‡ºå±±å‰å°±æ­»äºå°äººä¹‹æ‰‹ï¼š

```golang
func NewPlayer(name string) (Player, error) {
  if time.Now().Unix()%2 == 0 {
    return Player{}, errors.New("player dead")
  }
  return Player{Name: name}, nil
}
```

æˆ‘ä»¬ä½¿åˆ›å»º**éšæœºå¤±è´¥**ï¼Œä¿®æ”¹æ³¨å…¥å™¨`InitMission()`çš„ç­¾åï¼Œå¢åŠ `error`è¿”å›å€¼ï¼š

```golang
func InitMission(name string) (Mission, error) {
  wire.Build(NewMonster, NewPlayer, NewMission)
  return Mission{}, nil
}
```

ç”Ÿæˆçš„ä»£ç ï¼Œä¼šå°†`NewPlayer()`è¿”å›çš„é”™è¯¯ï¼Œä½œä¸º`InitMission()`çš„è¿”å›å€¼ï¼š

```golang
func InitMission(name string) (Mission, error) {
  player, err := NewPlayer(name)
  if err != nil {
    return Mission{}, err
  }
  monster := NewMonster()
  mission := NewMission(player, monster)
  return mission, nil
}
```

`wire`éµå¾ª**fail-fast**çš„åŸåˆ™ï¼Œé”™è¯¯å¿…é¡»è¢«å¤„ç†ã€‚å¦‚æœæˆ‘ä»¬çš„æ³¨å…¥å™¨ä¸è¿”å›é”™è¯¯ï¼Œä½†æ„é€ å™¨è¿”å›é”™è¯¯ï¼Œ`wire`å·¥å…·ä¼šæŠ¥é”™ï¼

## é«˜çº§ç‰¹æ€§

ä¸‹é¢ç®€å•ä»‹ç»ä¸€ä¸‹`wire`çš„é«˜çº§ç‰¹æ€§ã€‚

### ProviderSet

æœ‰æ—¶å€™å¯èƒ½å¤šä¸ªç±»å‹æœ‰ç›¸åŒçš„ä¾èµ–ï¼Œæˆ‘ä»¬æ¯æ¬¡éƒ½å°†ç›¸åŒçš„æ„é€ å™¨ä¼ ç»™`wire.Build()`ä¸ä»…ç¹çï¼Œè€Œä¸”ä¸æ˜“ç»´æŠ¤ï¼Œä¸€ä¸ªä¾èµ–ä¿®æ”¹äº†ï¼Œæ‰€æœ‰ä¼ å…¥`wire.Build()`çš„åœ°æ–¹éƒ½è¦ä¿®æ”¹ã€‚ä¸ºæ­¤ï¼Œ`wire`æä¾›äº†ä¸€ä¸ª`ProviderSet`ï¼ˆæ„é€ å™¨é›†åˆï¼‰ï¼Œå¯ä»¥å°†å¤šä¸ªæ„é€ å™¨æ‰“åŒ…æˆä¸€ä¸ªé›†åˆï¼Œåç»­åªéœ€è¦ä½¿ç”¨è¿™ä¸ªé›†åˆå³å¯ã€‚å‡è®¾ï¼Œæˆ‘ä»¬æœ‰å…³å‹‡å£«å’Œæ€ªå…½çš„æ•…äº‹æœ‰ä¸¤ä¸ªç»“å±€ï¼š

```golang
type EndingA struct {
  Player  Player
  Monster Monster
}

func NewEndingA(p Player, m Monster) EndingA {
  return EndingA{p, m}
}

func (p EndingA) Appear() {
  fmt.Printf("%s defeats %s, world peace!\n", p.Player.Name, p.Monster.Name)
}

type EndingB struct {
  Player  Player
  Monster Monster
}

func NewEndingB(p Player, m Monster) EndingB {
  return EndingB{p, m}
}

func (p EndingB) Appear() {
  fmt.Printf("%s defeats %s, but become monster, world darker!\n", p.Player.Name, p.Monster.Name)
}
```

ç¼–å†™ä¸¤ä¸ªæ³¨å…¥å™¨ï¼š

```golang
func InitEndingA(name string) EndingA {
  wire.Build(NewMonster, NewPlayer, NewEndingA)
  return EndingA{}
}

func InitEndingB(name string) EndingB {
  wire.Build(NewMonster, NewPlayer, NewEndingB)
  return EndingB{}
}
```

æˆ‘ä»¬è§‚å¯Ÿåˆ°ä¸¤æ¬¡è°ƒç”¨`wire.Build()`éƒ½éœ€è¦ä¼ å…¥`NewMonster`å’Œ`NewPlayer`ã€‚ä¸¤ä¸ªè¿˜å¥½ï¼Œå¦‚æœå¾ˆå¤šçš„è¯å†™èµ·æ¥å°±éº»çƒ¦äº†ï¼Œè€Œä¸”ä¿®æ”¹ä¹Ÿä¸å®¹æ˜“ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå®šä¹‰ä¸€ä¸ª`ProviderSet`ï¼š

```golang
var monsterPlayerSet = wire.NewSet(NewMonster, NewPlayer)
```

åç»­ç›´æ¥ä½¿ç”¨è¿™ä¸ª`set`ï¼š

```golang
func InitEndingA(name string) EndingA {
  wire.Build(monsterPlayerSet, NewEndingA)
  return EndingA{}
}

func InitEndingB(name string) EndingB {
  wire.Build(monsterPlayerSet, NewEndingB)
  return EndingB{}
}
```

è€Œåå¦‚æœè¦æ·»åŠ æˆ–åˆ é™¤æŸä¸ªæ„é€ å™¨ï¼Œç›´æ¥ä¿®æ”¹`set`çš„å®šä¹‰å¤„å³å¯ã€‚

### ç»“æ„æ„é€ å™¨

å› ä¸ºæˆ‘ä»¬çš„`EndingA`å’Œ`EndingB`çš„å­—æ®µåªæœ‰`Player`å’Œ`Monster`ï¼Œæˆ‘ä»¬å°±ä¸éœ€è¦æ˜¾å¼ä¸ºå®ƒä»¬æä¾›æ„é€ å™¨ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨`wire`æä¾›çš„**ç»“æ„æ„é€ å™¨**ï¼ˆStruct Providerï¼‰ã€‚ç»“æ„æ„é€ å™¨åˆ›å»ºæŸä¸ªç±»å‹çš„ç»“æ„ï¼Œç„¶åç”¨å‚æ•°æˆ–è°ƒç”¨å…¶å®ƒæ„é€ å™¨å¡«å……å®ƒçš„å­—æ®µã€‚ä¾‹å¦‚ä¸Šé¢çš„ä¾‹å­ï¼Œæˆ‘ä»¬å»æ‰`NewEndingA()`å’Œ`NewEndingB()`ï¼Œç„¶åä¸ºå®ƒä»¬æä¾›ç»“æ„æ„é€ å™¨ï¼š

```golang
var monsterPlayerSet = wire.NewSet(NewMonster, NewPlayer)

var endingASet = wire.NewSet(monsterPlayerSet, wire.Struct(new(EndingA), "Player", "Monster"))
var endingBSet = wire.NewSet(monsterPlayerSet, wire.Struct(new(EndingB), "Player", "Monster"))

func InitEndingA(name string) EndingA {
  wire.Build(endingASet)
  return EndingA{}
}

func InitEndingB(name string) EndingB {
  wire.Build(endingBSet)
  return EndingB{}
}
```

ç»“æ„æ„é€ å™¨ä½¿ç”¨`wire.Struct`æ³¨å…¥ï¼Œç¬¬ä¸€ä¸ªå‚æ•°å›ºå®šä¸º`new(ç»“æ„å)`ï¼Œåé¢å¯æ¥ä»»æ„å¤šä¸ªå‚æ•°ï¼Œè¡¨ç¤ºéœ€è¦ä¸ºè¯¥ç»“æ„çš„å“ªäº›å­—æ®µæ³¨å…¥å€¼ã€‚ä¸Šé¢æˆ‘ä»¬éœ€è¦æ³¨å…¥`Player`å’Œ`Monster`ä¸¤ä¸ªå­—æ®µã€‚æˆ–è€…æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨é€šé…ç¬¦`*`è¡¨ç¤ºæ³¨å…¥æ‰€æœ‰å­—æ®µï¼š

```golang
var endingASet = wire.NewSet(monsterPlayerSet, wire.Struct(new(EndingA), "*"))
var endingBSet = wire.NewSet(monsterPlayerSet, wire.Struct(new(EndingB), "*"))
```

`wire`ä¸ºæˆ‘ä»¬ç”Ÿæˆæ­£ç¡®çš„ä»£ç ï¼Œéå¸¸æ£’ï¼š

```golang
func InitEndingA(name string) EndingA {
  player := NewPlayer(name)
  monster := NewMonster()
  endingA := EndingA{
    Player:  player,
    Monster: monster,
  }
  return endingA
}
```

### ç»‘å®šå€¼

æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºæŸä¸ªç±»å‹ç»‘å®šä¸€ä¸ªå€¼ï¼Œè€Œä¸æƒ³ä¾èµ–æ„é€ å™¨æ¯æ¬¡éƒ½åˆ›å»ºä¸€ä¸ªæ–°çš„å€¼ã€‚æœ‰äº›ç±»å‹å¤©ç”Ÿå°±æ˜¯å•ä¾‹ï¼Œä¾‹å¦‚é…ç½®ï¼Œæ•°æ®åº“å¯¹è±¡ï¼ˆ`sql.DB`ï¼‰ã€‚è¿™æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`wire.Value`ç»‘å®šå€¼ï¼Œä½¿ç”¨`wire.InterfaceValue`ç»‘å®šæ¥å£ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬çš„æ€ªå…½ä¸€ç›´æ˜¯ä¸€ä¸ª`Kitty`ï¼Œæˆ‘ä»¬å°±ä¸ç”¨æ¯æ¬¡éƒ½å–åˆ›å»ºå®ƒäº†ï¼Œç›´æ¥ç»‘å®šè¿™ä¸ªå€¼å°± ok äº†ï¼š

```golang
var kitty = Monster{Name: "kitty"}

func InitEndingA(name string) EndingA {
  wire.Build(NewPlayer, wire.Value(kitty), NewEndingA)
  return EndingA{}
}

func InitEndingB(name string) EndingB {
  wire.Build(NewPlayer, wire.Value(kitty), NewEndingB)
  return EndingB{}
}
```

æ³¨æ„ä¸€ç‚¹ï¼Œè¿™ä¸ªå€¼æ¯æ¬¡ä½¿ç”¨æ—¶éƒ½ä¼šæ‹·è´ï¼Œéœ€è¦ç¡®ä¿æ‹·è´æ— å‰¯ä½œç”¨ï¼š

```golang
// wire_gen.go
func InitEndingA(name string) EndingA {
  player := NewPlayer(name)
  monster := _wireMonsterValue
  endingA := NewEndingA(player, monster)
  return endingA
}

var (
  _wireMonsterValue = kitty
)
```

### ç»“æ„å­—æ®µä½œä¸ºæ„é€ å™¨

æœ‰æ—¶å€™æˆ‘ä»¬ç¼–å†™ä¸€ä¸ªæ„é€ å™¨ï¼Œåªæ˜¯ç®€å•çš„è¿”å›æŸä¸ªç»“æ„çš„ä¸€ä¸ªå­—æ®µï¼Œè¿™æ—¶å¯ä»¥ä½¿ç”¨`wire.FieldsOf`ç®€åŒ–æ“ä½œã€‚ç°åœ¨æˆ‘ä»¬ç›´æ¥åˆ›å»ºäº†`Mission`ç»“æ„ï¼Œå¦‚æœæƒ³è·å¾—`Monster`å’Œ`Player`ç±»å‹çš„å¯¹è±¡ï¼Œå°±å¯ä»¥å¯¹`Mission`ä½¿ç”¨`wire.FieldsOf`ï¼š

```golang
func NewMission() Mission {
  p := Player{Name: "dj"}
  m := Monster{Name: "kitty"}

  return Mission{p, m}
}

// wire.go
func InitPlayer() Player {
  wire.Build(NewMission, wire.FieldsOf(new(Mission), "Player"))
}

func InitMonster() Monster {
  wire.Build(NewMission, wire.FieldsOf(new(Mission), "Monster"))
}

// main.go
func main() {
  p := InitPlayer()
  fmt.Println(p.Name)
}
```

åŒæ ·çš„ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸º`new(ç»“æ„å)`ï¼Œåé¢è·Ÿå¤šä¸ªå‚æ•°è¡¨ç¤ºå°†å“ªäº›å­—æ®µä½œä¸ºæ„é€ å™¨ï¼Œ`*`è¡¨ç¤ºå…¨éƒ¨ã€‚

### æ¸…ç†å‡½æ•°

æ„é€ å™¨å¯ä»¥æä¾›ä¸€ä¸ªæ¸…ç†å‡½æ•°ï¼Œå¦‚æœåç»­çš„æ„é€ å™¨è¿”å›å¤±è´¥ï¼Œå‰é¢æ„é€ å™¨è¿”å›çš„æ¸…ç†å‡½æ•°éƒ½ä¼šè°ƒç”¨ï¼š

```golang
func NewPlayer(name string) (Player, func(), error) {
  cleanup := func() {
    fmt.Println("cleanup!")
  }
  if time.Now().Unix()%2 == 0 {
    return Player{}, cleanup, errors.New("player dead")
  }
  return Player{Name: name}, cleanup, nil
}

func main() {
  mission, cleanup, err := InitMission("dj")
  if err != nil {
    log.Fatal(err)
  }

  mission.Start()
  cleanup()
}

// wire.go
func InitMission(name string) (Mission, func(), error) {
  wire.Build(NewMonster, NewPlayer, NewMission)
  return Mission{}, nil, nil
}
```

## ä¸€äº›ç»†èŠ‚

é¦–å…ˆï¼Œæˆ‘ä»¬è°ƒç”¨`wire`ç”Ÿæˆ`wire_gen.go`ä¹‹åï¼Œå¦‚æœ`wire.go`æ–‡ä»¶æœ‰ä¿®æ”¹ï¼Œåªéœ€è¦æ‰§è¡Œ`go generate`å³å¯ã€‚`go generate`å¾ˆæ–¹ä¾¿ï¼Œæˆ‘ä¹‹å‰ä¸€ç¯‡æ–‡ç« å†™è¿‡`generate`ï¼Œæ„Ÿå…´è¶£å¯ä»¥çœ‹çœ‹[æ·±å…¥ç†è§£Goä¹‹generate](https://darjun.github.io/2019/08/21/golang-generate/)ã€‚

## æ€»ç»“

`wire`æ˜¯éšç€`go-cloud`çš„ç¤ºä¾‹[`guestbook`](https://github.com/google/go-cloud/tree/master/samples/guestbook)ä¸€èµ·å‘å¸ƒçš„ï¼Œå¯ä»¥é˜…è¯»`guestbook`çœ‹çœ‹å®ƒæ˜¯æ€ä¹ˆä½¿ç”¨`wire`çš„ã€‚ä¸`dig`ä¸åŒï¼Œ`wire`åªæ˜¯ç”Ÿæˆä»£ç ï¼Œä¸ä½¿ç”¨`reflect`åº“ï¼Œæ€§èƒ½æ–¹é¢æ˜¯ä¸ç”¨æ‹…å¿ƒçš„ã€‚å› ä¸ºå®ƒç”Ÿæˆçš„ä»£ç ä¸ä½ è‡ªå·±å†™çš„åŸºæœ¬æ˜¯ä¸€æ ·çš„ã€‚å¦‚æœç”Ÿæˆçš„ä»£ç æœ‰æ€§èƒ½é—®é¢˜ï¼Œè‡ªå·±å†™å¤§æ¦‚ç‡ä¹Ÿä¼šæœ‰ğŸ˜‚ã€‚

å¤§å®¶å¦‚æœå‘ç°å¥½ç©ã€å¥½ç”¨çš„ Go è¯­è¨€åº“ï¼Œæ¬¢è¿åˆ° Go æ¯æ—¥ä¸€åº“ GitHub ä¸Šæäº¤ issueğŸ˜„

## å‚è€ƒ

1. wire GitHubï¼š[https://github.com/google/wire](https://github.com/google/wire)
2. Go æ¯æ—¥ä¸€åº“ GitHubï¼š[https://github.com/darjun/go-daily-lib](https://github.com/darjun/go-daily-lib)

## æˆ‘

[æˆ‘çš„åšå®¢](https://darjun.github.io)

æ¬¢è¿å…³æ³¨æˆ‘çš„å¾®ä¿¡å…¬ä¼—å·ã€GoUpUpã€‘ï¼Œå…±åŒå­¦ä¹ ï¼Œä¸€èµ·è¿›æ­¥~

![](/img/wxgzh8.jpg#center)